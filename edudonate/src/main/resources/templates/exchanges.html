<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Exchanges | EduDonate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#fff8f2; font-family: 'Segoe UI', sans-serif; }
        .brand { color: #FF6600; font-weight:700; }
        .btn-brand { background:#FF6600; color:#fff; border-radius:8px; border:none; }
        .btn-brand:hover { background:#e05500; }
        .card { border-radius:10px; }
    </style>
</head>
<body>
<nav class="navbar navbar-light bg-light shadow-sm">
    <div class="container">
        <a class="navbar-brand brand" th:href="@{/}">EduDonate</a>
        <div>
            <a th:href="@{/dashboard}" class="btn btn-outline-secondary me-2">Dashboard</a>
            <a th:href="@{/exchange/new}" class="btn btn-brand">âž• New Exchange</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card p-3 mb-3">
        <h3 class="mb-0 brand">ðŸ”„ Exchange Listings</h3>
        <small class="text-muted">Browse items offered by other students</small>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>From User</th>
                <th>Item Offered</th>
                <th>Item Requested</th>
                <th>Status</th>
                <th>Accepted By</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="ex : ${exchanges}">
                <td th:text="${ex.fromUser}">FromUser</td>
                <td th:text="${ex.itemOffered}">Offered</td>
                <td th:text="${ex.itemRequested}">Requested</td>
                <td>
            <span th:switch="${ex.status}">
              <span th:case="'PENDING'" class="badge bg-warning text-dark" th:text="${ex.status}">PENDING</span>
              <span th:case="'ACCEPTED'" class="badge bg-success" th:text="${ex.status}">ACCEPTED</span>
              <span th:case="'COMPLETED'" class="badge bg-secondary" th:text="${ex.status}">COMPLETED</span>
              <span th:case="*"><span th:text="${ex.status}">UNKNOWN</span></span>
            </span>

                <td>
                    <!-- Accept button visible only when status is PENDING -->
                    <form th:action="@{'/exchange/accept/' + ${ex.id}}"
                          method="post"
                          th:if="${ex.status.name() == 'PENDING'}">
                        <!-- CSRF token for Spring Security -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-sm btn-success">Accept</button>
                    </form>
                    <form th:action="@{'/exchange/complete/' + ${ex.id}}"
                      method="post"
                      th:if="${ex.status.name() == 'ACCEPTED'}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-sm btn-primary">Complete</button>
                    </form>

                <!-- If not pending, show who accepted and a 'Completed' button optionally -->
                    <div th:if="${ex.status.name() != 'PENDING'}">
                        <span th:text="${ex.status.name()}"></span>
                        <span th:if="${ex.acceptedBy != null}"> by <strong th:text="${ex.acceptedBy}"></strong></span>
                    </div>
                </td>

            </tr>

            <tr th:if="${#lists.isEmpty(exchanges)}">
                <td colspan="6" class="text-center text-muted">No exchange listings available.</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>
